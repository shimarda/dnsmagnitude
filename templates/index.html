<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Magnitude ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; }
        .header h1 { font-size: 24px; }
        .controls { background: white; padding: 20px; margin: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .controls select, .controls button { padding: 10px; font-size: 14px; margin-right: 10px; }
        .content { margin: 20px; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #2c3e50; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #ecf0f1; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-box .value { font-size: 28px; font-weight: bold; color: #3498db; }
        .stat-box .label { font-size: 14px; color: #7f8c8d; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; }
        table th { background: #34495e; color: white; padding: 12px; text-align: left; }
        table td { padding: 12px; border-bottom: 1px solid #ecf0f1; }
        table tr:hover { background: #f8f9fa; }
        .chart-container { position: relative; height: 400px; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ DNS Magnitude ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    </div>

    <div class="controls">
        <label>æ—¥ä»˜é¸æŠ:</label>
        <select id="dateSelect">
            {% for date in available_dates %}
            <option value="{{ date }}" {% if date == latest_date %}selected{% endif %}>{{ date }}</option>
            {% endfor %}
        </select>
        <!-- ç›´æ¥æ—¥ä»˜å…¥åŠ›ï¼ˆYYYY-MM-DDï¼‰ -->
        <label style="margin-left:10px;">æ—¥ä»˜ç›´æ¥æŒ‡å®š:</label>
        <input type="date" id="dateInput" value="{{ latest_date }}">
        
        <label>ã‚µãƒ¼ãƒãƒ¼:</label>
        <select id="whereSelect">
            <option value="0">æ¨©å¨ã‚µãƒ¼ãƒãƒ¼</option>
            <option value="1">ãƒªã‚¾ãƒ«ãƒ</option>
        </select>
        
        <button onclick="loadData()">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
        <button onclick="loadDataFromInput()">æŒ‡å®šæ—¥ã§èª­ã¿è¾¼ã¿</button>
        <button onclick="location.href='/compare'">æ¯”è¼ƒè¡¨ç¤º</button>
        <div style="display:inline-block; margin-left:20px;">
            è¡¨ç¤ºä¸­: <strong id="currentDateLabel">-</strong>
        </div>
    </div>

    <div class="content">
        <div class="stats" id="statsContainer">
            <div class="stat-box">
                <div class="value" id="totalDomains">-</div>
                <div class="label">ç·ãƒ‰ãƒ¡ã‚¤ãƒ³æ•°</div>
            </div>
            <div class="stat-box">
                <div class="value" id="topMagnitude">-</div>
                <div class="label">æœ€å¤§Magnitude</div>
            </div>
            <div class="stat-box">
                <div class="value" id="avgMagnitude">-</div>
                <div class="label">å¹³å‡Magnitude</div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š Top 20 ãƒ‰ãƒ¡ã‚¤ãƒ³ (Magnitudeé †)</h2>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ å…¨ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <div style="margin-bottom: 10px;">
                <span id="domainCount">0</span> ãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºä¸­
            </div>
            <div style="max-height: 600px; overflow-y: auto;">
                <table id="dataTable">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th>é †ä½</th>
                            <th>ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³</th>
                            <th>Magnitude</th>
                            <th>å‰æ—¥æ¯”</th>
                            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let barChart = null;

        async function fetchAndRender(date, where) {
            try {
                const response = await fetch(`/api/magnitude/${date}?where=${where}`);
                const data = await response.json();

                if (data.error) {
                    alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                updateStats(data);
                updateChart(data);
                updateTable(data);

                // è¡¨ç¤ºä¸­ã®æ—¥ä»˜ã‚’æ›´æ–°ã—ã¦ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã¨å…¥åŠ›æ¬„ã‚’åŒæœŸã™ã‚‹
                try {
                    const select = document.getElementById('dateSelect');
                    const dateInput = document.getElementById('dateInput');

                    // select ã«è©²å½“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°å…ˆé ­ã«è¿½åŠ 
                    let found = false;
                    for (let i=0;i<select.options.length;i++){
                        if (select.options[i].value === date){
                            select.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }
                    if (!found){
                        const opt = document.createElement('option');
                        opt.value = date;
                        opt.text = date;
                        select.insertBefore(opt, select.firstChild);
                        select.selectedIndex = 0;
                    }

                    if (dateInput) dateInput.value = date;
                    const label = document.getElementById('currentDateLabel');
                    if (label) label.textContent = date;
                } catch (e) {
                    // åŒæœŸå¤±æ•—ã—ã¦ã‚‚è¡¨ç¤ºè‡ªä½“ã¯è¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã§ç„¡è¦–
                    console.warn('sync failed', e);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function loadData() {
            const date = document.getElementById('dateSelect').value;
            const where = document.getElementById('whereSelect').value;
            await fetchAndRender(date, where);
        }

        async function loadDataFromInput() {
            const date = document.getElementById('dateInput').value;
            if (!date) {
                alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            const where = document.getElementById('whereSelect').value;
            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ãŒå­˜åœ¨ã™ã‚Œã°åŒæœŸã•ã›ã‚‹ã€‚ãªã‘ã‚Œã°è¿½åŠ ã—ã¦é¸æŠã€‚
            const select = document.getElementById('dateSelect');
            let found = false;
            for (let i=0;i<select.options.length;i++){
                if (select.options[i].value === date){
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if (!found){
                const opt = document.createElement('option');
                opt.value = date;
                opt.text = date;
                select.insertBefore(opt, select.firstChild);
                select.selectedIndex = 0;
            }
            await fetchAndRender(date, where);
        }

        function updateStats(data) {
            document.getElementById('totalDomains').textContent = data.total_domains;
            
            if (data.domains.length > 0) {
                const topMag = data.domains[0].magnitude.toFixed(4);
                const avgMag = (data.domains.reduce((sum, d) => sum + d.magnitude, 0) / data.domains.length).toFixed(4);
                
                document.getElementById('topMagnitude').textContent = topMag;
                document.getElementById('avgMagnitude').textContent = avgMag;
            }
        }

        function updateChart(data) {
            const ctx = document.getElementById('barChart').getContext('2d');
            
            if (barChart) {
                barChart.destroy();
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆã¯Top 20ã®ã¿è¡¨ç¤º
            const top20 = data.domains.slice(0, 20);
            const labels = top20.map(d => d.subdomain);
            const values = top20.map(d => d.magnitude);
            
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'DNS Magnitude',
                        data: values,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // å…¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('domainCount').textContent = data.domains.length;
            
            data.domains.forEach((domain, index) => {
                const row = tbody.insertRow();
                
                // é †ä½å¤‰å‹•ã®è¡¨ç¤º
                let rankDiffHtml = '';
                if (domain.rank_diff !== null && domain.rank_diff !== undefined) {
                    const rDiff = domain.rank_diff;
                    if (rDiff > 0) {
                        rankDiffHtml = `<span style="color: #e74c3c; font-size: 0.8em; margin-left: 5px;">(â†‘${rDiff})</span>`;
                    } else if (rDiff < 0) {
                        rankDiffHtml = `<span style="color: #3498db; font-size: 0.8em; margin-left: 5px;">(â†“${Math.abs(rDiff)})</span>`;
                    } else {
                        rankDiffHtml = `<span style="color: #95a5a6; font-size: 0.8em; margin-left: 5px;">(-)</span>`;
                    }
                }

                let diffHtml = '<span style="color: #95a5a6;">-</span>';
                if (domain.diff !== null && domain.diff !== undefined) {
                    const diffVal = domain.diff;
                    const diffStr = diffVal > 0 ? `+${diffVal.toFixed(4)}` : diffVal.toFixed(4);
                    
                    // 0.1ä»¥ä¸Šã®å¤‰å‹•ã§çŸ¢å°ã‚’ã¤ã‘ã‚‹
                    if (diffVal >= 0.1) {
                        diffHtml = `<span style="color: #e74c3c; font-weight:bold;">â†‘ ${diffStr}</span>`;
                    } else if (diffVal <= -0.1) {
                        diffHtml = `<span style="color: #3498db; font-weight:bold;">â†“ ${diffStr}</span>`;
                    } else if (diffVal > 0) {
                        diffHtml = `<span style="color: #e74c3c;">${diffStr}</span>`;
                    } else if (diffVal < 0) {
                        diffHtml = `<span style="color: #3498db;">${diffStr}</span>`;
                    } else {
                        diffHtml = `<span style="color: #95a5a6;">0.0000</span>`;
                    }
                } else {
                     diffHtml = '<span style="color: #f39c12; font-weight:bold; font-size: 0.9em;">New</span>';
                }

                row.innerHTML = `
                    <td>${index + 1} ${rankDiffHtml}</td>
                    <td><strong>${domain.subdomain}</strong></td>
                    <td>${domain.magnitude.toFixed(6)}</td>
                    <td>${diffHtml}</td>
                    <td><button onclick="showTrend('${domain.subdomain}')">ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤º</button></td>
                `;
            });
        }

        function showTrend(subdomain) {
            const where = document.getElementById('whereSelect').value;
            window.open(`/trend?subdomain=${subdomain}&where=${where}`, '_blank');
        }

        // åˆå›èª­ã¿è¾¼ã¿
        window.onload = () => {
            // dateInput ã‚’ select ã®ç¾åœ¨å€¤ã«æƒãˆã‚‹ï¼ˆæœ€æ–°æ—¥ä»˜ãŒ template ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ï¼‰
            const select = document.getElementById('dateSelect');
            const dateInput = document.getElementById('dateInput');
            if (select && select.value && dateInput) {
                dateInput.value = select.value;
            }

            if (select && select.value) {
                loadData();
            }
        };
        // ç›¸äº’åŒæœŸ: select / dateInput ã® change ã‚¤ãƒ™ãƒ³ãƒˆã§åŒæœŸã—ã¦è‡ªå‹•èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('dateSelect');
            const dateInput = document.getElementById('dateInput');
            if (select) {
                select.addEventListener('change', () => {
                    if (dateInput) dateInput.value = select.value;
                    loadData();
                });
            }
            if (dateInput) {
                dateInput.addEventListener('change', () => {
                    loadDataFromInput();
                });
            }
        });
    </script>
</body>
</html>