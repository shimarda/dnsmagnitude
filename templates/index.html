<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Magnitude ダッシュボード</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; }
        .header h1 { font-size: 24px; }
        .controls { background: white; padding: 20px; margin: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .controls select, .controls button { padding: 10px; font-size: 14px; margin-right: 10px; }
        .content { margin: 20px; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #2c3e50; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #ecf0f1; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-box .value { font-size: 28px; font-weight: bold; color: #3498db; }
        .stat-box .label { font-size: 14px; color: #7f8c8d; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; }
        table th { background: #34495e; color: white; padding: 12px; text-align: left; }
        table td { padding: 12px; border-bottom: 1px solid #ecf0f1; }
        table tr:hover { background: #f8f9fa; }
        .chart-container { position: relative; height: 400px; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌐 DNS Magnitude 監視ダッシュボード</h1>
    </div>

    <div class="controls">
        <label>日付選択:</label>
        <select id="dateSelect">
            {% for date in available_dates %}
            <option value="{{ date }}" {% if date == latest_date %}selected{% endif %}>{{ date }}</option>
            {% endfor %}
        </select>
        <!-- 直接日付入力（YYYY-MM-DD） -->
        <label style="margin-left:10px;">日付直接指定:</label>
        <input type="date" id="dateInput" value="{{ latest_date }}">
        
        <label>サーバー:</label>
        <select id="whereSelect">
            <option value="0">権威サーバー</option>
            <option value="1">リゾルバ</option>
        </select>
        
        <button onclick="loadData()">データ読み込み</button>
        <button onclick="loadDataFromInput()">指定日で読み込み</button>
        <button onclick="location.href='/compare'">比較表示</button>
        <div style="display:inline-block; margin-left:20px;">
            表示中: <strong id="currentDateLabel">-</strong>
        </div>
    </div>

    <div class="content">
        <div class="stats" id="statsContainer">
            <div class="stat-box">
                <div class="value" id="totalDomains">-</div>
                <div class="label">総ドメイン数</div>
            </div>
            <div class="stat-box">
                <div class="value" id="topMagnitude">-</div>
                <div class="label">最大Magnitude</div>
            </div>
            <div class="stat-box">
                <div class="value" id="avgMagnitude">-</div>
                <div class="label">平均Magnitude</div>
            </div>
        </div>

        <div class="card">
            <h2>📊 Top 20 ドメイン (Magnitude順)</h2>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>📋 全ドメインランキング</h2>
            <div style="margin-bottom: 10px;">
                <span id="domainCount">0</span> ドメイン表示中
            </div>
            <div style="max-height: 600px; overflow-y: auto;">
                <table id="dataTable">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th>順位</th>
                            <th>サブドメイン</th>
                            <th>Magnitude</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="4" class="loading">データを読み込んでください</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let barChart = null;

        async function fetchAndRender(date, where) {
            try {
                const response = await fetch(`/api/magnitude/${date}?where=${where}`);
                const data = await response.json();

                if (data.error) {
                    alert('データが見つかりません');
                    return;
                }

                // レンダリング
                updateStats(data);
                updateChart(data);
                updateTable(data);

                // 表示中の日付を更新して、プルダウンと入力欄を同期する
                try {
                    const select = document.getElementById('dateSelect');
                    const dateInput = document.getElementById('dateInput');

                    // select に該当オプションがなければ先頭に追加
                    let found = false;
                    for (let i=0;i<select.options.length;i++){
                        if (select.options[i].value === date){
                            select.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }
                    if (!found){
                        const opt = document.createElement('option');
                        opt.value = date;
                        opt.text = date;
                        select.insertBefore(opt, select.firstChild);
                        select.selectedIndex = 0;
                    }

                    if (dateInput) dateInput.value = date;
                    const label = document.getElementById('currentDateLabel');
                    if (label) label.textContent = date;
                } catch (e) {
                    // 同期失敗しても表示自体は行われているので無視
                    console.warn('sync failed', e);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('データの読み込みに失敗しました');
            }
        }

        async function loadData() {
            const date = document.getElementById('dateSelect').value;
            const where = document.getElementById('whereSelect').value;
            await fetchAndRender(date, where);
        }

        async function loadDataFromInput() {
            const date = document.getElementById('dateInput').value;
            if (!date) {
                alert('日付を入力してください');
                return;
            }
            const where = document.getElementById('whereSelect').value;
            // プルダウンの選択肢が存在すれば同期させる。なければ追加して選択。
            const select = document.getElementById('dateSelect');
            let found = false;
            for (let i=0;i<select.options.length;i++){
                if (select.options[i].value === date){
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if (!found){
                const opt = document.createElement('option');
                opt.value = date;
                opt.text = date;
                select.insertBefore(opt, select.firstChild);
                select.selectedIndex = 0;
            }
            await fetchAndRender(date, where);
        }

        function updateStats(data) {
            document.getElementById('totalDomains').textContent = data.total_domains;
            
            if (data.domains.length > 0) {
                const topMag = data.domains[0].magnitude.toFixed(4);
                const avgMag = (data.domains.reduce((sum, d) => sum + d.magnitude, 0) / data.domains.length).toFixed(4);
                
                document.getElementById('topMagnitude').textContent = topMag;
                document.getElementById('avgMagnitude').textContent = avgMag;
            }
        }

        function updateChart(data) {
            const ctx = document.getElementById('barChart').getContext('2d');
            
            if (barChart) {
                barChart.destroy();
            }
            
            // チャートはTop 20のみ表示
            const top20 = data.domains.slice(0, 20);
            const labels = top20.map(d => d.subdomain);
            const values = top20.map(d => d.magnitude);
            
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'DNS Magnitude',
                        data: values,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // 全ドメインを表示
            document.getElementById('domainCount').textContent = data.domains.length;
            
            data.domains.forEach((domain, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${domain.subdomain}</strong></td>
                    <td>${domain.magnitude.toFixed(6)}</td>
                    <td><button onclick="showTrend('${domain.subdomain}')">トレンド表示</button></td>
                `;
            });
        }

        function showTrend(subdomain) {
            const where = document.getElementById('whereSelect').value;
            window.open(`/trend?subdomain=${subdomain}&where=${where}`, '_blank');
        }

        // 初回読み込み
        window.onload = () => {
            // dateInput を select の現在値に揃える（最新日付が template から渡される）
            const select = document.getElementById('dateSelect');
            const dateInput = document.getElementById('dateInput');
            if (select && select.value && dateInput) {
                dateInput.value = select.value;
            }

            if (select && select.value) {
                loadData();
            }
        };
        // 相互同期: select / dateInput の change イベントで同期して自動読み込み
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('dateSelect');
            const dateInput = document.getElementById('dateInput');
            if (select) {
                select.addEventListener('change', () => {
                    if (dateInput) dateInput.value = select.value;
                    loadData();
                });
            }
            if (dateInput) {
                dateInput.addEventListener('change', () => {
                    loadDataFromInput();
                });
            }
        });
    </script>
</body>
</html>